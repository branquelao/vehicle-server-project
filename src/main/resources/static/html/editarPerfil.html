<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil</title>
    <link rel="preload" href="/img/fundo.jpg" as="image">
    <link rel="preload" href="/img/fundo.webp" as="image">
    <link rel="icon" type="image/png" href="/img/favicon-full.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

<style>
    .perfil-foto:hover {
      transform: scale(1.03);
      box-shadow: 0 0 25px #00ffff80;
    }

    .perfil-foto:hover .camera-icon {
      opacity: 1;
      pointer-events: all;
    }

    .camera-icon:hover {
      transform: scale(1.1);
      color: #f9f002;
      text-shadow: 0 0 10px #000, 0 0 20px #00eaff;
    }

    .perfil-foto:hover .foto-preview {
      filter: brightness(0.6);
    }
</style>

<div class="container mt-4">
    <div class="menuP d-flex justify-content-around align-items-center">
        <a href="index.html">Home</a>
        <a href="carros.html">Carros</a>
        <a href="motos.html">Motos</a>
        <a href="anunciar.html">Anunciar</a>
    </div>
</div>

<div class="container mt-5 text-center text-light perfil-container">
    <div class="perfil-header d-flex flex-column align-items-center">
        <div class="perfil-foto mb-3 position-relative">
            <img id="fotoPerfil" src="../img/default-user.png" alt="" class="foto-preview">
            <label for="inputFoto" class="camera-icon">
                <i class="bi bi-camera-fill"></i>
            </label>
            <input type="file" id="inputFoto" accept="image/*" style="display: none;">
        </div>
        <h1 class="perfil-nome mb-4">Editar Perfil</h1>
    </div>

    <form id="formPadronizado" class="text-start mx-auto" style="max-width: 400px;">
        <div class="mb-3">
            <label class="form-label">Usu√°rio</label>
            <input type="text" class="form-control" id="usuario" placeholder="Digite seu novo usu√°rio" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Telefone</label>
            <input type="tel" class="form-control" id="telefone" placeholder="(xx) xxxxx-xxxx" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" placeholder="Digite sua nova senha" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Confirmar Senha</label>
            <input type="password" class="form-control" id="confirmarSenha" placeholder="Confirme a sua senha" required><br>
        </div>

        <div class="d-flex flex-column align-items-center gap-3 mt-4">
            <button type="submit" class="btn btn-cyber w-50">Salvar Altera√ß√µes</button>
            <button type="button" class="btn btn-cyber w-50" onclick="window.location.href='perfil.html'">Cancelar</button>
        </div>
    </form>
</div>

<footer class="footer mt-5 py-4">
    <div class="container text-center">
        <h5 class="mb-3">Burnout Zone! üöóüèçÔ∏è</h5>
        <p class="mb-2">O melhor site para an√∫ncios dos melhores ve√≠culos!</p>

        <div class="social-icons mb-3">
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-youtube"></i></a>
        </div>

        <p class="mb-0">&copy; 2025 - Burnout Zone!‚Ñ¢ | Feito por grupo Na M√£o de Deus</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
      const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
      const inputFoto = document.getElementById("inputFoto");
      const fotoPerfil = document.getElementById("fotoPerfil");

      // Mostra a foto atual, se existir
      if (usuarioLogado?.loginImagem) {
        fotoPerfil.src = `http://localhost:8080/uploads/${usuarioLogado.loginImagem}`;
      }

      // Upload autom√°tico ao selecionar nova imagem
      inputFoto.addEventListener("change", async (event) => {
        const arquivo = event.target.files[0];
        if (!arquivo) return;

        const formData = new FormData();
        formData.append("imagem", arquivo);

        try {
          const resposta = await fetch(`http://localhost:8080/login/${usuarioLogado.id}/imagem`, {
            method: "PUT",
            body: formData
          });

          if (!resposta.ok) throw new Error("Erro ao atualizar imagem.");

          const usuarioAtualizado = await resposta.json();
          localStorage.setItem("usuarioLogado", JSON.stringify(usuarioAtualizado));

          fotoPerfil.src = `http://localhost:8080/uploads/${usuarioAtualizado.loginImagem}`;
          alert("Imagem de perfil atualizada com sucesso!");
        } catch (erro) {
          console.error(erro);
          alert("Erro ao enviar imagem de perfil.");
        }
      });

      // Atualiza informa√ß√µes do perfil (usu√°rio, telefone, senha)
      const form = document.getElementById("formPadronizado");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const usuario = document.getElementById("usuario").value.trim();
        const telefone = document.getElementById("telefone").value.trim();
        const senha = document.getElementById("senha").value.trim();
        const confirmarSenha = document.getElementById("confirmarSenha").value.trim();

        if (!usuario || !telefone || !senha || !confirmarSenha) {
          alert("Preencha todos os campos para atualizar as informa√ß√µes!");
          return;
        }

        if (senha !== confirmarSenha) {
          alert("As senhas n√£o coincidem!");
          return;
        }

        const objAtualizado = {
          id: usuarioLogado.id,
          usuario,
          telefone,
          senha,
          carteira: usuarioLogado.carteira,
          loginImagem: usuarioLogado.loginImagem
        };

        try {
          const resp = await fetch(`http://localhost:8080/login/${usuarioLogado.id}`, {
            method: "PUT",
            headers: {
              "Accept": "application/json",
              "Content-Type": "application/json"
            },
            body: JSON.stringify(objAtualizado)
          });

          if (!resp.ok) throw new Error("Erro ao atualizar perfil.");
          const atualizado = await resp.json();

          localStorage.setItem("usuarioLogado", JSON.stringify(atualizado));
          alert("Perfil atualizado com sucesso!");
          window.location.href = "perfil.html";
        } catch (erro) {
          console.error(erro);
          alert("Erro ao atualizar perfil!");
        }
      });
    });
</script>

</body>
</html>
