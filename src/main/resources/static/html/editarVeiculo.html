<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Ve√≠culo</title>
    <link rel="icon" type="image/png" href="/img/favicon-full.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
</head>
<body>

<style>
    .input-group-text {
      background-color: #ff005e !important;
      color: #000000 !important;
      font-weight: bold;
      border: none;
    }

    input[type="file"]::file-selector-button {
      background-color: #ff005e;
      color: #000000;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-weight: 600;
      transition: 0.3s;
    }

    input::placeholder,
    textarea::placeholder,
    select::placeholder {
      color: #cccccc !important;
      opacity: 0.3 !important;
    }

    /* ===== Layout padronizado ===== */
    .painel-anuncio {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 60px;
      margin-top: 50px;
      flex-wrap: wrap;
    }

    .admin-container {
      max-width: 500px;
      margin: 0;
    }

    #preview-container {
      width: 500px;
      height: 400px;
      border: 2px dashed #ff005e;
      border-radius: 15px;
      background: rgba(20, 20, 20, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      color: #bbb;
      font-size: 20px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(255, 0, 94, 0.2);
    }

    #preview-container:hover {
      border-color: #ff3377;
      background: rgba(25, 25, 25, 0.95);
      box-shadow: 0 0 14px rgba(255, 0, 94, 0.4);
    }

    #preview-placeholder {
      position: absolute;
      pointer-events: none;
    }

    #preview {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      display: none;
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    #preview.show {
      display: block;
      opacity: 1;
    }
</style>

<div class="container mt-4">
    <div class="menuP d-flex justify-content-around align-items-center">
        <a href="index.html">Home</a>
        <a href="carros.html">Carros</a>
        <a href="motos.html">Motos</a>
        <a href="anunciar.html">Anunciar</a>
    </div>
</div><br>

<a href="perfil.html" class="btn btn-black rounded-circle perfil-btn">
    <i class="bi bi-person-fill"></i>
</a>

<!-- ===== Painel de Edi√ß√£o ===== -->
<div class="painel-anuncio">
    <div class="admin-container p-4">
        <h2 class="text-center mb-4">Editar Ve√≠culo</h2>

        <form id="form-editar">
            <!-- Tipo -->
            <div class="mb-3">
                <label for="tipo" class="form-label">Tipo de ve√≠culo</label>
                <select class="form-select" id="tipo" disabled>
                    <option value="carro">Carro</option>
                    <option value="moto">Moto</option>
                </select>
            </div>

            <!-- Nome -->
            <div class="mb-3">
                <label for="nome" class="form-label">Nome do ve√≠culo</label>
                <input type="text" class="form-control" id="nome" placeholder="Digite o nome do ve√≠culo" required>
            </div>

            <!-- Cor -->
            <div class="mb-3">
                <label for="cor" class="form-label">Cor</label>
                <input type="text" class="form-control" id="cor" placeholder="Digite a cor do ve√≠culo" required>
            </div>

            <!-- Ano -->
            <div class="mb-3">
                <label for="ano" class="form-label">Ano</label>
                <input type="number" class="form-control" id="ano" placeholder="Ex: 2022" min="1900" max="2099" required>
            </div>

            <!-- Valor -->
            <div class="mb-3">
                <label for="valor" class="form-label">Valor</label>
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" class="form-control" id="valor" placeholder="Digite o valor do ve√≠culo" step="0.01" required>
                </div>
            </div>

            <!-- Imagem -->
            <div class="mb-4">
                <label for="imagem" class="form-label">Imagem (opcional para alterar)</label>
                <input class="form-control" type="file" id="imagem" accept="image/*">
            </div>

            <!-- Bot√£o -->
            <div class="text-center">
                <button type="submit" class="btn btn-cyber w-50">Salvar Altera√ß√µes</button><br>
                <button type="button" class="btn btn-cyber w-50 mt-3" onclick="window.location.href='historico.html'">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Cont√™iner da imagem -->
    <div id="preview-container">
        <span id="preview-placeholder">Adicione uma imagem!</span>
        <img id="preview" alt="Pr√©-visualiza√ß√£o da imagem">
    </div>
</div>

<footer class="footer mt-5 py-4">
    <div class="container text-center">
        <h5 class="mb-3">Burnout Zone! üöóüèçÔ∏è</h5>
        <p class="mb-2">O melhor site para an√∫ncios dos melhores ve√≠culos!</p>

        <div class="social-icons mb-3">
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-youtube"></i></a>
        </div>

        <p class="mb-0">&copy; 2025 - Burnout Zone!‚Ñ¢ | Feito por grupo Na M√£o de Deus</p>
    </div>
</footer>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const tipo = params.get("tipo"); // 'carro' ou 'moto'
      const id = params.get("id");

      if (!tipo || !id) {
        alert("Ve√≠culo inv√°lido para edi√ß√£o!");
        window.location.href = "historico.html";
        return;
      }

      // pega loginId do localStorage
      const usuarioLogado = localStorage.getItem("usuarioLogado");
      if (!usuarioLogado) {
        alert("Voc√™ precisa estar logado!");
        window.location.href = "login.html";
        return;
      }

      const login = JSON.parse(usuarioLogado);
      window.loginId = login.id;

      // buscar dados do ve√≠culo
      try {
        const resp = await fetch(`http://localhost:8080/veiculos/${tipo}/${id}`);
        if (!resp.ok) throw new Error("Erro ao buscar dados do ve√≠culo.");
        const veiculo = await resp.json();

        // preencher os campos
        document.querySelector("#tipo").value = tipo;
        document.querySelector("#nome").value = veiculo[`${tipo}Nome`];
        document.querySelector("#cor").value = veiculo[`${tipo}Cor`];
        document.querySelector("#ano").value = veiculo[`${tipo}Ano`];
        document.querySelector("#valor").value = veiculo[`${tipo}Valor`];
        document.querySelector("#preview").src = `../uploads/${veiculo[`${tipo}Imagem`]}`;
        document.querySelector("#preview").classList.add("show");
        document.querySelector("#preview-placeholder").style.display = "none";
        document.querySelector("#imagem").dataset.imagemAtual = veiculo[`${tipo}Imagem`];
      } catch (erro) {
        console.error(erro);
        alert("Erro ao carregar dados para edi√ß√£o!");
      }
    });

    // ===== SUBMIT =====
    document.querySelector("form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const params = new URLSearchParams(window.location.search);
      const tipo = params.get("tipo");
      const id = params.get("id");

      const nome = document.querySelector("#nome").value;
      const cor = document.querySelector("#cor").value;
      const ano = parseInt(document.querySelector("#ano").value);
      const valor = parseFloat(document.querySelector("#valor").value);
      const imagemInput = document.querySelector("#imagem");
      const imagemArquivo = imagemInput.files[0];
      const loginId = window.loginId;
      let nomeImagem = imagemInput.dataset.imagemAtual || "";

      // Se o usu√°rio escolheu uma nova imagem, faz upload e atualiza nome
      if (imagemArquivo) {
        nomeImagem = imagemArquivo.name;
        const formData = new FormData();
        formData.append("file", imagemArquivo);

        try {
          const uploadResp = await fetch("http://localhost:8080/uploads", {
            method: "POST",
            body: formData
          });

          if (!uploadResp.ok) {
            const erroTexto = await uploadResp.text();
            alert("Erro ao enviar imagem: " + erroTexto);
            return;
          }

          console.log("Nova imagem enviada:", nomeImagem);
        } catch (err) {
          console.error(err);
          alert("Erro durante o upload da imagem!");
          return;
        }
      }

      const dados = {
        [`${tipo}Nome`]: nome,
        [`${tipo}Cor`]: cor,
        [`${tipo}Ano`]: ano,
        [`${tipo}Valor`]: valor,
        [`${tipo}Imagem`]: nomeImagem,
        loginId: parseInt(loginId)
      };

      try {
        const resposta = await fetch(`http://localhost:8080/veiculos/${tipo}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados)
        });

        if (resposta.ok) {
          alert("Ve√≠culo atualizado com sucesso!");
          window.location.href = "historico.html";
        } else {
          const erro = await resposta.text();
          alert("Erro ao atualizar ve√≠culo: " + erro);
        }
      } catch (err) {
        console.error(err);
        alert("Erro ao conectar com o servidor!");
      }
    });

    // ===== PREVIEW =====
    document.getElementById("imagem").addEventListener("change", (event) => {
      const file = event.target.files[0];
      const preview = document.getElementById("preview");
      const placeholder = document.getElementById("preview-placeholder");

      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          placeholder.style.display = "none";
          preview.classList.add("show");
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.classList.remove("show");
        placeholder.style.display = "block";
      }
    });
</script>

</body>
</html>
